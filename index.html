<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>German Juicies ‚Äì Deutscher Juice WRLD Discord</title>
  <meta name="description" content="German Juicies ‚Äì der erste rein deutschsprachige Juice WRLD Discord Server. Musik, Austausch & 999-Spirit." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      background: #050505;
      color: #ffffff;
      text-align: center;
    }

    h1, h2 {
      font-family: "Bebas Neue", sans-serif;
      letter-spacing: 4px;
    }

    /* ================= TOP BAR ================= */

    .topbar {
      position: sticky;
      top: 0;
      z-index: 999;
      background: rgba(8,8,8,0.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      transform: translateY(-120%);
      animation: topbarIn 0.7s ease-out forwards;
    }

    @keyframes topbarIn {
      to { transform: translateY(0); }
    }

    nav {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      text-decoration: none;
      color: white;
      font-size: 1.2rem;
    }

    .navlinks {
      display: flex;
      gap: 20px;
      align-items: center;
    }

    .navlinks a {
      color: rgba(255,255,255,0.85);
      text-decoration: none;
      font-weight: 600;
    }

    .navlinks a:hover {
      color: white;
      text-decoration: underline;
    }

    .nav-cta {
      background: #ff1a1a;
      padding: 10px 18px;
      border-radius: 10px;
      color: white !important;
      font-weight: 800;
      text-decoration: none !important;
    }

    /* ================= HAMBURGER ================= */

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
    }

    .hamburger span {
      width: 28px;
      height: 3px;
      background: white;
      transition: 0.35s ease;
    }

    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(6px, 6px);
    }

    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* ================= MOBILE MENU ================= */

    .mobile-menu {
      position: fixed;
      inset: 0;
      background: rgba(5,5,5,0.96);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 30px;
      font-size: 1.5rem;
      transform: translateY(-100%);
      transition: 0.4s ease;
      z-index: 998;
    }

    .mobile-menu.active {
      transform: translateY(0);
    }

    .mobile-menu a {
      color: white;
      text-decoration: none;
      font-weight: 700;
    }

    /* ================= HERO ================= */

    .hero {
      position: relative;
      overflow: hidden;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 120px 20px 80px;
    }

    .hero-inner {
      z-index: 3;
      max-width: 900px;
    }

    .hero h1 {
      font-size: clamp(3rem, 7vw, 5rem);
      margin-bottom: 16px;
    }

    .hero p {
      opacity: 0.85;
      line-height: 1.6;
      margin-bottom: 36px;
      font-size: 1.15rem;
    }

    .btn-primary {
      display: inline-block;
      padding: 16px 46px;
      background: #ff1a1a;
      color: white;
      border-radius: 14px;
      text-decoration: none;
      font-weight: 800;
      border: 0;
      cursor: pointer;
    }

    .btn-primary:hover {
      background: #ff3b3b;
    }

    /* ================= 999 + SMOKE ================= */

    .ghost-999 {
      position: absolute;
      top: 48%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: clamp(6rem, 20vw, 15rem);
      font-family: "Bebas Neue";
      color: rgba(180,80,255,0.12);
      text-shadow: 0 0 40px rgba(180,80,255,.35);
      filter: blur(1.2px);
      z-index: 1;
      animation: ghostFade 9s ease-in-out infinite;
    }

    @keyframes ghostFade {
      0%,100% { opacity: .35; }
      50% { opacity: .6; }
    }

    .hero::before,
    .hero::after {
      content:"";
      position:absolute;
      left:-20%;
      width:140%;
      height:70%;
      bottom:-40%;
      filter: blur(35px);
      z-index:2;
    }

    .hero::before {
      background: radial-gradient(circle, rgba(160,70,255,.55), transparent 70%);
      animation: smoke1 12s ease-in-out infinite;
    }

    .hero::after {
      background: radial-gradient(circle, rgba(200,100,255,.45), transparent 75%);
      animation: smoke2 9s ease-in-out infinite;
    }

    @keyframes smoke1 {
      50% { transform: translateY(-25%); }
    }

    @keyframes smoke2 {
      50% { transform: translateY(-35%); }
    }

    /* ================= SECTIONS ================= */

    .section {
      max-width: 900px;
      margin: 0 auto;
      padding: 90px 20px;
    }

    .section p {
      opacity: .85;
      line-height: 1.7;
    }

    ul {
      list-style: none;
      padding: 0;
      display: grid;
      gap: 14px;
      margin: 30px 0 40px;
      text-align: left;
    }

    li {
      padding: 14px 16px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.07);
    }

    footer {
      opacity: .45;
      padding: 30px;
      font-size: .85rem;
    }

    /* ================= MANIFEST SEAL ================= */

    .manifest-seal {
      margin-top: 46px;
      display: inline-block;
      padding: 14px 18px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      letter-spacing: 3px;
      font-weight: 900;
      opacity: .95;
      text-transform: uppercase;
    }

    /* ================= WALL ================= */

    .wall-wrap {
      text-align: left;
      margin-top: 26px;
    }

    .wall-note {
      opacity: .75;
      line-height: 1.7;
      margin: 18px 0 28px;
      text-align: left;
    }

    .wall-form {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 18px;
      padding: 18px;
      text-align: left;
    }

    .field {
      display: grid;
      gap: 8px;
      margin-bottom: 14px;
    }

    .label {
      font-weight: 700;
      opacity: .9;
    }

    .hint {
      font-size: .9rem;
      opacity: .65;
      line-height: 1.5;
      margin-top: -4px;
    }

    input[type="text"], textarea {
      width: 100%;
      box-sizing: border-box;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      color: white;
      border-radius: 14px;
      padding: 12px 12px;
      font-family: "Space Grotesk", sans-serif;
      font-size: 1rem;
      outline: none;
    }

    textarea {
      min-height: 130px;
      resize: vertical;
      line-height: 1.6;
    }

    input[type="text"]:focus, textarea:focus {
      border-color: rgba(255,255,255,.24);
    }

    .wall-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .subtle {
      opacity: .7;
      font-size: .9rem;
      line-height: 1.5;
    }

    .cards {
      margin-top: 30px;
      display: grid;
      gap: 16px;
    }

    .card {
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      padding: 18px;
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      opacity: .8;
      font-size: .95rem;
      margin-bottom: 10px;
    }

    .card h3 {
      margin: 18px 0 8px;
      font-size: 1.15rem;
      letter-spacing: 1px;
      font-family: "Space Grotesk", sans-serif;
      font-weight: 900;
      opacity: .95;
      text-transform: none;
    }

    .card p {
      margin: 0 0 10px;
      opacity: .86;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .meta-line {
      margin-top: 8px;
      opacity: .8;
      font-size: .95rem;
    }

    .msg {
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      opacity: .92;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .signature {
      margin-top: 12px;
      opacity: .75;
      font-weight: 700;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,.08);
      margin: 18px 0;
    }

    .comments-title {
      font-weight: 900;
      opacity: .92;
      margin: 0 0 10px;
      letter-spacing: 1px;
      text-align: left;
    }

    .comment {
      border-radius: 14px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.07);
      background: rgba(255,255,255,.02);
      margin-bottom: 10px;
    }

    .comment-head {
      opacity: .75;
      font-size: .92rem;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .comment-body {
      opacity: .86;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .comment-form {
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }

    .owner-bar {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
    }

    .btn-ghost {
      display: inline-block;
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: transparent;
      color: white;
      font-weight: 800;
      cursor: pointer;
    }

    .btn-ghost:hover {
      border-color: rgba(255,255,255,.22);
    }

    /* ================= RESPONSIVE ================= */

    @media (max-width: 820px) {
      .navlinks { display: none; }
      .hamburger { display: flex; }
    }
  </style>
</head>

<body>

<header class="topbar">
  <nav>
    <a class="brand" href="#top">GERMAN JUICIES</a>

    <div class="navlinks">
      <a href="#features">Was dich erwartet</a>
      <a href="#manifest">Manifest</a>
      <a href="#values">Werte</a>
      <a href="#against">Haltung</a>
      <a href="#wall">999 Wall</a>
      <a class="nav-cta" href="https://discord.gg/9BEbDqnFcZ" target="_blank" rel="noopener">Discord</a>
    </div>

    <div class="hamburger" id="hamburger" aria-label="Men√º √∂ffnen" role="button" tabindex="0">
      <span></span><span></span><span></span>
    </div>
  </nav>
</header>

<div class="mobile-menu" id="mobileMenu">
  <a href="#features">Was dich erwartet</a>
  <a href="#manifest">Manifest</a>
  <a href="#values">Werte</a>
  <a href="#against">Haltung</a>
  <a href="#wall">999 Wall</a>
  <a href="https://discord.gg/9BEbDqnFcZ" target="_blank" rel="noopener">Discord</a>
</div>

<section class="hero" id="top">
  <div class="ghost-999">999</div>
  <div class="hero-inner">
    <h1>GERMAN JUICIES</h1>
    <p>
      Der erste rein deutschsprachige Juice WRLD Discord-Server ‚Äî<br />
      Musik, Austausch &amp; 999-Spirit.
    </p>
    <a class="btn-primary" href="https://discord.gg/9BEbDqnFcZ" target="_blank" rel="noopener">
      Join the German Juicies
    </a>
  </div>
</section>

<section id="features" class="section">
  <h2>Was dich erwartet</h2>
  <ul>
    <li>üéµ Legacy-Talks &amp; Deep Dives ‚Äì Songs, Lyrics, Storys &amp; Releases</li>
    <li>üéß Musik &amp; Austausch ‚Äì Empfehlungen, Playlists, neue Artists</li>
    <li>üß† Community &amp; Support ‚Äì Gespr√§che &amp; gegenseitiger R√ºckhalt</li>
    <li>üéÆ Gaming &amp; Chill ‚Äì zocken, labern, abschalten</li>
    <li>üî• Aktionen &amp; Community-Projekte ‚Äì Events &amp; Ideen</li>
  </ul>
  <a class="btn-primary" href="https://discord.gg/9BEbDqnFcZ" target="_blank" rel="noopener">
    Join the German Juicies
  </a>
</section>

<section id="manifest" class="section">
  <h2>THE 999 MANIFEST</h2>

  <p>
    Wir sind Menschen, die sich in der Musik wiedergefunden haben.<br />
    Dabei war Juice Wrld kein Trend ‚Äì er war ein Spiegel
  </p>

  <p>
    Mit Allem, was wir tun, f√∂rdern wir den 999-Spirit.<br />
    999 bedeutet nicht, gl√ºcklich zu sein ‚Äì es bedeutet, aus jeder beschissenen Situation das Beste zu machen.
  </p>

  <div class="manifest-seal">TURN THE EVIL UPSIDE DOWN</div>
</section>

<section id="values" class="section">
  <h2>Wof√ºr stehen wir?</h2>
  <ul>
    <li>üñ§ Ehrlichkeit statt Poser-Image</li>
    <li>üéß Musik als Spache</li>
    <li>ü´±üèø‚Äçü´≤üèª Respekt vor jedem Struggle</li>
    <li>üö´ Kein Gatekeeping</li>
  </ul>
</section>

<section id="against" class="section">
  <h2>Wogegen wir stehen</h2>
  <p>
    Wir stehen gegen das stille Verschwinden dieser Community im deutschsprachigen Raum.<br />
    Gegen den Moment, in dem Juice nur noch ein ‚Äûwar mal‚Äú-Name ist.
  </p>
  <p>
    Mit jedem Post, jeder Aktion, jeder neuen Person, die sich traut zu bleiben,<br />
    halten wir das Verm√§chtnis <strong>lebendig</strong> ‚Äî hier, auf Deutsch, gemeinsam.
  </p>
</section>

<section id="community" class="section">
  <h2>Community</h2>
  <p>
    Von Fans f√ºr Fans. Rein deutschsprachig.<br />
    F√ºr alle, die die Musik f√ºhlen und Teil davon sein wollen.
  </p>
</section>

<section id="wall" class="section">
  <h2>THE 999 WALL</h2>

  <p class="wall-note">
    Teile deine Story. Ohne Account. Ohne Filter.<br />
    Beitr√§ge erscheinen sofort √∂ffentlich.<br />
    Inhalte k√∂nnen vom Betreiber jederzeit bearbeitet oder entfernt werden.
  </p>

  <div class="wall-form" id="wallForm">
    <div class="field">
      <div class="label">1) Wie hast du Juice WRLD kennengelernt? <span style="opacity:.7;">(Pflicht)</span></div>
      <div class="hint">Schreib‚Äôs so lang, wie‚Äôs sein muss.</div>
      <textarea id="f_discovered" placeholder="..."></textarea>
    </div>

    <div class="field">
      <div class="label">2) Wie hat er dein Leben auf Dauer beeinflusst? <span style="opacity:.7;">(Pflicht)</span></div>
      <div class="hint">Kein Limit. Keine Vorgaben.</div>
      <textarea id="f_impact" placeholder="..."></textarea>
    </div>

    <div class="field">
      <div class="label">3) Ein Song, der f√ºr dich alles bedeutet? <span style="opacity:.7;">(Optional)</span></div>
      <input id="f_song" type="text" placeholder="z.B. Legends / Empty / Wishing Well ..." />
    </div>

    <div class="field">
      <div class="label">4) Deine Message an die Community? <span style="opacity:.7;">(Optional)</span></div>
      <textarea id="f_message" placeholder="..."></textarea>
    </div>

    <div class="field">
      <div class="label">5) Signatur (Name, Nick, Social Media, etc.) <span style="opacity:.7;">(Optional)</span></div>
      <input id="f_signature" type="text" placeholder="z.B. Anonym / Alex / @deininsta" />
    </div>

    <div class="field">
      <div class="label">6) Ort <span style="opacity:.7;">(Optional)</span></div>
      <input id="f_location" type="text" placeholder="z.B. Berlin / NRW / √ñsterreich" />
    </div>

    <div class="wall-actions">
      <button class="btn-primary" id="submitStory">Story ver√∂ffentlichen</button>
      <span class="subtle" id="statusText"></span>
    </div>

    <div class="owner-bar">
      <button class="btn-ghost" id="ownerToggle">Owner-Mode</button>
      <span class="subtle" id="ownerStatus"></span>
    </div>
  </div>

  <div class="wall-wrap">
    <div class="cards" id="stories"></div>
  </div>

  <p class="subtle" style="margin-top:18px; text-align:left;">
    Hinweis: Diese GitHub-Version speichert Stories/Kommentare aktuell nur im Browser (Demo-Modus).<br />
    Wenn du willst, mache ich dir als n√§chsten Schritt die echte ‚Äû√∂ffentlich f√ºr alle‚Äú-Version mit Datenbank-Anbindung.
  </p>
</section>

<footer>
  ¬© German Juicies ¬∑ 999
</footer>

<!-- Firebase SDKs (Compat, damit GitHub Pages ohne Build funktioniert) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>

<script>
  // =============================
  // FIREBASE INIT
  // =============================
  const firebaseConfig = {
    apiKey: "AIzaSyCMO8Swb6ofACiGtfDugMGWH8D6lA2fMaI",
    authDomain: "german-juicies.firebaseapp.com",
    projectId: "german-juicies",
    storageBucket: "german-juicies.firebasestorage.app",
    messagingSenderId: "545322609178",
    appId: "1:545322609178:web:ffcba0dea5f09112fa3fa3",
    measurementId: "G-ZJ9HM5JSKS"
  };

  firebase.initializeApp(firebaseConfig);

  // Analytics kann auf manchen Setups/Browsern blockiert werden ‚Äì ist egal f√ºr die Wall
  try { firebase.analytics(); } catch (e) {}

  const db = firebase.firestore();
  const auth = firebase.auth();

  // =============================
  // 999 WALL - FIRESTORE (√∂ffentlich, global sichtbar)
  // =============================

  // Stories: collection "wallStories"
  // Comments: subcollection "comments" unter jedem Story-Doc
  const STORIES_COL = "wallStories";

  // Owner PIN Hash (SHA-256). Aktuell Platzhalter (leer-string hash).
  // Wenn du deinen echten PIN willst:
  // - sag mir deinen gew√ºnschten PIN (oder "mach mir einen"),
  // - dann geb ich dir den SHA-256, den du hier eintr√§gst.
  const OWNER_PIN_HASH = "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855";

  let ownerMode = false;

  function normalizeText(str) {
    return (str || "").trim();
  }

  function escapeHtml(str) {
    return (str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  function getDisplayName(signature) {
    const s = normalizeText(signature);
    return s ? s : "Anonym";
  }

  function getHeadLine(signature, location) {
    const name = getDisplayName(signature);
    const loc = normalizeText(location);
    return loc ? `${name} ¬∑ ${loc}` : `${name}`;
  }

  function tsToDate(ts) {
    if (!ts) return null;
    // Firestore Timestamp (compat) hat toDate()
    if (typeof ts.toDate === "function") return ts.toDate();
    // falls doch JS Date
    if (ts instanceof Date) return ts;
    return null;
  }

  function fmtDate(ts) {
    const d = tsToDate(ts);
    if (!d) return "";
    return d.toLocaleString("de-DE");
  }

  async function sha256Hex(str) {
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // Comment listeners sauber halten
  let commentUnsubs = [];

  function cleanupCommentListeners() {
    for (const u of commentUnsubs) {
      try { u(); } catch (e) {}
    }
    commentUnsubs = [];
  }

  function buildStoryCard(story) {
    const card = document.createElement("div");
    card.className = "card";

    const head = document.createElement("div");
    head.className = "card-head";

    const left = document.createElement("div");
    left.textContent = getHeadLine(story.signature, story.location);

    const right = document.createElement("div");
    right.textContent = fmtDate(story.createdAt);

    head.appendChild(left);
    head.appendChild(right);

    const h3a = document.createElement("h3");
    h3a.textContent = "Wie ich Juice WRLD kennengelernt habe";
    const pa = document.createElement("p");
    pa.innerHTML = escapeHtml(story.discovered);

    const h3b = document.createElement("h3");
    h3b.textContent = "Wie er mein Leben auf Dauer beeinflusst hat";
    const pb = document.createElement("p");
    pb.innerHTML = escapeHtml(story.impact);

    card.appendChild(head);
    card.appendChild(h3a);
    card.appendChild(pa);
    card.appendChild(h3b);
    card.appendChild(pb);

    if (normalizeText(story.song)) {
      const meta = document.createElement("div");
      meta.className = "meta-line";
      meta.innerHTML = `üéß <strong>Song(e):</strong> ${escapeHtml(story.song)}`;
      card.appendChild(meta);
    }

    if (normalizeText(story.message)) {
      const msg = document.createElement("div");
      msg.className = "msg";
      msg.innerHTML = escapeHtml(story.message);
      card.appendChild(msg);
    }

    const sig = document.createElement("div");
    sig.className = "signature";
    sig.textContent = "‚Äì " + getDisplayName(story.signature);
    card.appendChild(sig);

    // Owner Controls
    if (ownerMode) {
      const ownerBar = document.createElement("div");
      ownerBar.className = "owner-bar";

      const btnEdit = document.createElement("button");
      btnEdit.className = "btn-ghost";
      btnEdit.textContent = "Edit";
      btnEdit.onclick = () => ownerEditStory(story);

      const btnDel = document.createElement("button");
      btnDel.className = "btn-ghost";
      btnDel.textContent = "Delete";
      btnDel.onclick = () => ownerDeleteStory(story.id);

      ownerBar.appendChild(btnEdit);
      ownerBar.appendChild(btnDel);
      card.appendChild(ownerBar);
    }

    const div = document.createElement("div");
    div.className = "divider";
    card.appendChild(div);

    // Comments Title
    const ct = document.createElement("div");
    ct.className = "comments-title";
    ct.textContent = "üí≠ Antworten aus der Community";
    card.appendChild(ct);

    const commentsWrap = document.createElement("div");
    commentsWrap.id = `comments_${story.id}`;
    card.appendChild(commentsWrap);

    // Comment form
    const cf = document.createElement("div");
    cf.className = "comment-form";

    const ctext = document.createElement("textarea");
    ctext.placeholder = "Kommentar schreiben‚Ä¶ (ohne Diskussion, ohne Bewertung)";

    const cRow = document.createElement("div");
    cRow.style.display = "flex";
    cRow.style.gap = "10px";
    cRow.style.flexWrap = "wrap";

    const csig = document.createElement("input");
    csig.type = "text";
    csig.placeholder = "Signatur (optional)";

    const cloc = document.createElement("input");
    cloc.type = "text";
    cloc.placeholder = "Ort (optional)";

    cRow.appendChild(csig);
    cRow.appendChild(cloc);

    const cbtn = document.createElement("button");
    cbtn.className = "btn-primary";
    cbtn.textContent = "Kommentar ver√∂ffentlichen";
    cbtn.onclick = async () => {
      const t = normalizeText(ctext.value);
      if (!t) return;

      cbtn.disabled = true;
      try {
        await db.collection(STORIES_COL)
          .doc(story.id)
          .collection("comments")
          .add({
            text: t,
            signature: normalizeText(csig.value),
            location: normalizeText(cloc.value),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

        ctext.value = "";
        csig.value = "";
        cloc.value = "";
      } catch (e) {
        alert("Kommentar konnte nicht gespeichert werden. (Check Firestore Rules / Console)");
      } finally {
        cbtn.disabled = false;
      }
    };

    cf.appendChild(ctext);
    cf.appendChild(cRow);
    cf.appendChild(cbtn);

    card.appendChild(cf);

    // Realtime comments listener (chronologisch: √§lteste zuerst)
    const unsub = db.collection(STORIES_COL)
      .doc(story.id)
      .collection("comments")
      .orderBy("createdAt", "asc")
      .onSnapshot((snap) => {
        const target = document.getElementById(`comments_${story.id}`);
        if (!target) return;

        target.innerHTML = "";

        snap.forEach((doc) => {
          const c = doc.data();
          const cdiv = document.createElement("div");
          cdiv.className = "comment";

          const chead = document.createElement("div");
          chead.className = "comment-head";

          const cleft = document.createElement("div");
          cleft.textContent = getHeadLine(c.signature, c.location);

          const cright = document.createElement("div");
          cright.textContent = fmtDate(c.createdAt);

          chead.appendChild(cleft);
          chead.appendChild(cright);

          const cbody = document.createElement("div");
          cbody.className = "comment-body";
          cbody.innerHTML = escapeHtml(c.text);

          cdiv.appendChild(chead);
          cdiv.appendChild(cbody);

          if (ownerMode) {
            const ob = document.createElement("div");
            ob.className = "owner-bar";

            const ed = document.createElement("button");
            ed.className = "btn-ghost";
            ed.textContent = "Edit";
            ed.onclick = () => ownerEditComment(story.id, doc.id, c);

            const del = document.createElement("button");
            del.className = "btn-ghost";
            del.textContent = "Delete";
            del.onclick = () => ownerDeleteComment(story.id, doc.id);

            ob.appendChild(ed);
            ob.appendChild(del);
            cdiv.appendChild(ob);
          }

          target.appendChild(cdiv);
        });
      }, (err) => {
        // Falls Rules blocken -> sichtbar machen
        const target = document.getElementById(`comments_${story.id}`);
        if (target) {
          target.innerHTML = `<div class="subtle" style="text-align:left;">Kommentare konnten nicht geladen werden. (Firestore Rules / Console)</div>`;
        }
      });

    commentUnsubs.push(unsub);

    return card;
  }

  function clearForm() {
    document.getElementById("f_discovered").value = "";
    document.getElementById("f_impact").value = "";
    document.getElementById("f_song").value = "";
    document.getElementById("f_message").value = "";
    document.getElementById("f_signature").value = "";
    document.getElementById("f_location").value = "";
  }

  document.getElementById("submitStory").addEventListener("click", async () => {
    const discovered = normalizeText(document.getElementById("f_discovered").value);
    const impact = normalizeText(document.getElementById("f_impact").value);
    const song = normalizeText(document.getElementById("f_song").value);
    const message = normalizeText(document.getElementById("f_message").value);
    const signature = normalizeText(document.getElementById("f_signature").value);
    const location = normalizeText(document.getElementById("f_location").value);

    const status = document.getElementById("statusText");
    status.textContent = "";

    if (!discovered || !impact) {
      status.textContent = "Bitte f√ºlle die beiden Pflichtfelder aus.";
      return;
    }

    const btn = document.getElementById("submitStory");
    btn.disabled = true;

    try {
      await db.collection(STORIES_COL).add({
        discovered,
        impact,
        song,
        message,
        signature,
        location,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      clearForm();
      status.textContent = "Ver√∂ffentlicht.";
    } catch (e) {
      status.textContent = "Konnte nicht speichern. (Check Firestore Rules / Console)";
    } finally {
      btn.disabled = false;
    }
  });

  // =============================
  // OWNER MODE (PIN)
  // =============================
  document.getElementById("ownerToggle").addEventListener("click", async () => {
    const ownerStatus = document.getElementById("ownerStatus");

    if (ownerMode) {
      ownerMode = false;
      ownerStatus.textContent = "Owner-Mode aus.";
      // Re-render owner buttons sichtbar/unsichtbar
      // -> Stories listener triggert ohnehin; wir rendern sofort neu:
      forceRerender();
      return;
    }

    const pin = prompt("Owner-PIN:");
    if (pin === null) return;

    const hash = await sha256Hex(pin);
    if (hash === OWNER_PIN_HASH) {
      ownerMode = true;
      ownerStatus.textContent = "Owner-Mode an.";
      forceRerender();
    } else {
      ownerStatus.textContent = "Falsche PIN.";
    }
  });

  async function ownerDeleteStory(storyId) {
    if (!ownerMode) return;
    const ok = confirm("Story wirklich l√∂schen?");
    if (!ok) return;

    try {
      // Kommentare vorher l√∂schen (Firestore l√∂scht Subcollections nicht automatisch)
      const commentsSnap = await db.collection(STORIES_COL).doc(storyId).collection("comments").get();
      const batch = db.batch();
      commentsSnap.forEach((d) => batch.delete(d.ref));
      batch.delete(db.collection(STORIES_COL).doc(storyId));
      await batch.commit();
    } catch (e) {
      alert("L√∂schen fehlgeschlagen. (Rules?)");
    }
  }

  async function ownerEditStory(story) {
    if (!ownerMode) return;

    const newDiscovered = prompt("Edit: Wie kennengelernt?", story.discovered || "");
    if (newDiscovered === null) return;

    const newImpact = prompt("Edit: Einfluss?", story.impact || "");
    if (newImpact === null) return;

    const newSong = prompt("Edit: Song(e) (optional)", story.song || "");
    if (newSong === null) return;

    const newMessage = prompt("Edit: Message (optional)", story.message || "");
    if (newMessage === null) return;

    const newSig = prompt("Edit: Signatur (optional)", story.signature || "");
    if (newSig === null) return;

    const newLoc = prompt("Edit: Ort (optional)", story.location || "");
    if (newLoc === null) return;

    try {
      await db.collection(STORIES_COL).doc(story.id).update({
        discovered: normalizeText(newDiscovered),
        impact: normalizeText(newImpact),
        song: normalizeText(newSong),
        message: normalizeText(newMessage),
        signature: normalizeText(newSig),
        location: normalizeText(newLoc)
      });
    } catch (e) {
      alert("Bearbeiten fehlgeschlagen. (Rules?)");
    }
  }

  async function ownerDeleteComment(storyId, commentId) {
    if (!ownerMode) return;
    const ok = confirm("Kommentar wirklich l√∂schen?");
    if (!ok) return;

    try {
      await db.collection(STORIES_COL).doc(storyId).collection("comments").doc(commentId).delete();
    } catch (e) {
      alert("Kommentar l√∂schen fehlgeschlagen. (Rules?)");
    }
  }

  async function ownerEditComment(storyId, commentId, cData) {
    if (!ownerMode) return;

    const newText = prompt("Edit: Kommentar", cData.text || "");
    if (newText === null) return;

    const newSig = prompt("Edit: Signatur (optional)", cData.signature || "");
    if (newSig === null) return;

    const newLoc = prompt("Edit: Ort (optional)", cData.location || "");
    if (newLoc === null) return;

    try {
      await db.collection(STORIES_COL).doc(storyId).collection("comments").doc(commentId).update({
        text: normalizeText(newText),
        signature: normalizeText(newSig),
        location: normalizeText(newLoc)
      });
    } catch (e) {
      alert("Kommentar bearbeiten fehlgeschlagen. (Rules?)");
    }
  }

  // =============================
  // STORIES REALTIME LISTENER
  // =============================
  let latestStoriesCache = [];

  function renderStories(stories) {
    const root = document.getElementById("stories");
    root.innerHTML = "";

    cleanupCommentListeners();

    for (const s of stories) {
      root.appendChild(buildStoryCard(s));
    }
  }

  function forceRerender() {
    renderStories(latestStoriesCache);
  }

  db.collection(STORIES_COL)
    .orderBy("createdAt", "desc") // Neueste zuerst (wie besprochen)
    .onSnapshot((snap) => {
      const stories = [];
      snap.forEach((doc) => {
        stories.push({ id: doc.id, ...doc.data() });
      });

      latestStoriesCache = stories;
      renderStories(stories);
    }, (err) => {
      const root = document.getElementById("stories");
      if (root) {
        root.innerHTML = `<div class="subtle" style="text-align:left;">Stories konnten nicht geladen werden. (Firestore Rules / Console)</div>`;
      }
    });

  // =============================
  // MOBILE MENU (unver√§ndert)
  // =============================
  const burger = document.getElementById("hamburger");
  const menu = document.getElementById("mobileMenu");

  function toggleMenu() {
    burger.classList.toggle("active");
    menu.classList.toggle("active");
  }

  burger.addEventListener("click", toggleMenu);
  burger.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") toggleMenu();
  });

  document.querySelectorAll(".mobile-menu a").forEach(link => {
    link.addEventListener("click", () => {
      burger.classList.remove("active");
      menu.classList.remove("active");
    });
  });
</script>
  
</body>
</html>
